# Rubik Motion Lab: Project Roadmap & Development Plan

## 1. Текущий статус и проблемы (Diagnosis)
*   **Баги OLL:** Некорректный рендеринг формул с перехватами (целые повороты куба: `x`, `x'`, `y`, `z`). Проблема, вероятно, в `cubeanim.formula` или `cubeanim.state`, где перехват не учитывается в финальной ориентации или цепочке анимаций.
*   **Архитектурный долг:** Смешанные источники данных (txt, py-константы). Папка `scripts/` требует категоризации.
*   **Производительность:** Очередь Manim (однопоточная) — узкое место при массовом рендеринге OLL-кейсов.
*   **Workflow:** Использование 3-х ворктри для параллельной работы агентов — эффективная стратегия, требующая четкого разделения задач, чтобы избежать конфликтов при слиянии (merge).

## 2. Приоритетные задачи (Short-Term: 1-2 недели)

### А. Исправление логики перехватов (OLL Fix)
*   [ ] Анализ `cubeanim/formula.py`: добавить поддержку токенов `x`, `y`, `z` и их производных.
*   [ ] Обновление `cubeanim/state.py`: убедиться, что `set_state` (инверсные ходы) корректно обрабатывает перехват как смену базиса ориентации, а не просто поворот слоев.
*   [ ] Тестирование: создать набор тестов в `tests/test_rotations.py` для верификации каждого типа перехвата.

### Б. Миграция данных в SQLite (Data-Driven Customization)
*   [ ] Заполнение `db/cards_schema.sql` стартовым набором OLL/PLL.
*   [ ] Реализация CRUD-интерфейса в `scripts/cards_api.py` для кастомизации формул пользователем (замена системной формулы на свою).
*   [ ] Удаление устаревших `.txt` и `.py` файлов с константами алгоритмов.

### В. Реорганизация скриптов
*   [ ] `scripts/dev/`: `dev_tmux.sh`, `dev_worktrees.sh`.
*   [ ] `scripts/app/`: `cards_api.py`, `cards_worker.py`.
*   [ ] `scripts/tools/`: `render_algo.py`, `render_ui.py`, `pdf_to_images.py`.

## 3. Масштабирование и Инфраструктура (Mid-Term)

### А. Параллельный рендеринг
*   [ ] Перевод `cards_worker.py` на мультипроцессорность. Запуск N воркеров (по количеству ядер CPU), каждый из которых слушает очередь задач.
*   [ ] Оптимизация ресурсов: ограничение количества потоков Manim на один процесс для предотвращения перегрузки RAM.

### Б. Абстракция Рендерера (Renderer Interface)
*   [ ] Создание `cubeanim/render_base.py` с интерфейсом `BaseRenderer`.
*   [ ] Реализация `ManimRenderer` (текущий).
*   [ ] Исследование: `InteractiveRenderer` (экспорт данных в JSON для Three.js плеера) для мгновенного превью в вебе.

## 4. Стратегия Агентной Разработки (Multi-Worktree)
Для эффективной работы в 3 ворктри распределяем задачи следующим образом:

1.  **Worktree 1 (Core/Bugfix):** Исправление багов рендеринга (OLL), работа над ядром `cubeanim`, тесты.
2.  **Worktree 2 (Data/API):** Миграция в БД, кастомизация формул, развитие API и логики "карточек".
3.  **Worktree 3 (UI/UX):** Развитие фронтенда, интерактивный плеер, визуальные улучшения (палитры, фингертриксы-подсказки).

**Merge-политика:** Main-ветка должна быть всегда стабильной. Ворк-три сливаются через PR (или прямой merge), когда фича протестирована локально.

## 5. Будущие исследования (Backlog)
*   [ ] Интеграция ManimGL для использования GPU.
*   [ ] Перенос логики анимации на клиент (Web/JS) для интерактивности.
*   [ ] Автоматическая генерация "названий" и "групп" для новых пользовательских формул через LLM (с осторожностью).
